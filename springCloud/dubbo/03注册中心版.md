资料来源：
[rpc框架dubbo从原理到使用](https://mrhelloworld.com/dubbo/#dubbo-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8)

## 注册中心

　注册中心我们已经学习了不少，例如：ZooKeeper、Eureka、Consul、Nacos 等等，注册中心可以更高效的管理系统的服务：比如服务接口的发布、自动剔除无效的服务、自动恢复服务等。

　　Dubbo 支持五种注册中心：Multicast、Nacos(推荐)、ZooKeeper(推荐) 、Redis、Simple。本文重点介绍前两个，更多注册中心的信息请参考：http://dubbo.apache.org/zh-cn/docs/user/references/registry/introduction.html

## ZooKeeper

　　Apache ZooKeeper 是一个开放源码的分布式应用程序协调组件，是 Hadoop 和 Hbase 的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。适合作为 Dubbo 服务的注册中心，工业强度较高，可用于生产环境，推荐使用。

　　在微服务项目开发中 ZooKeeper 主要的角色是当做服务注册中心存在，我们将编写好的服务注册至 ZooKeeper 即可。

![img](https://mrhelloworld.com/resources/articles/dubbo/zookeeper.jpg)

流程说明：

- 服务提供者启动时: 向 `/dubbo/com.foo.BarService/providers` 目录下写入自己的 URL 地址。
- 服务消费者启动时: 订阅 `/dubbo/com.foo.BarService/providers` 目录下的提供者 URL 地址。并向 `/dubbo/com.foo.BarService/consumers` 目录下写入自己的 URL 地址。
- 监控中心启动时: 订阅 `/dubbo/com.foo.BarService` 目录下的所有提供者和消费者 URL 地址。



　　支持以下功能：

- 当提供者出现断电等异常停机时，注册中心能自动删除提供者信息；
- 当注册中心重启时，能自动恢复注册数据，以及订阅请求；
- 当会话过期时，能自动恢复注册数据，以及订阅请求；
- 当设置 `<dubbo:registry check="false" />` 时，记录失败注册和订阅请求，后台定时重试；
- 可通过 `<dubbo:registry username="admin" password="1234" />` 设置 zookeeper 登录信息；
- 可通过 `<dubbo:registry group="dubbo" />` 设置 zookeeper 的根节点，不配置将使用默认的根节点；
- 支持 `*` 号通配符 `<dubbo:reference group="*" version="*" />`，可订阅服务的所有分组和所有版本的提供者。

　当您将 ZooKeeper 整合到您的 Dubbo 工程之前，请确保后台已经启动 ZooKeeper 服务。

### 依赖的jar包

　　在 provider 和 consumer 中增加 zookeeper 客户端 jar 包依赖：

~~~~xml
<dependency>
    <groupId>org.apache.zookeeper</groupId>
    <artifactId>zookeeper</artifactId>
    <version>3.6.1</version>
</dependency>

<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-framework</artifactId>
    <version>5.1.0</version>
</dependency>
~~~~

> Dubbo 支持 zkclient 和 curator 两种 Zookeeper 客户端实现：
>
> **注意：**<br/>
> **1.在 2.7.x 的版本中已经移除了 zkclient 的实现，如果要使用 zkclient 客户端，需要自行拓展。**<br/>
> **2. 单独添加 zookeeper 和 curator 依赖需要注意版本之间是否有冲突，较为麻烦。**

所以，一劳永逸的办法就是添加 Apache Dubbo 给定的一个已关联好的依赖：
~~~~xml
<dependency>
    <groupId>org.apache.dubbo</groupId>
    <artifactId>dubbo-dependencies-zookeeper</artifactId>
    <version>${dubbo.version}</version>
    <type>pom</type>
</dependency>
~~~~
!> zookeeper和dubbo版本号一致，否则会报版本冲突问题

### 配置

**ZooKeeper 单机配置**

~~~~xml
<dubbo:registry address="zookeeper://191.168.10.101:2181" />
~~~~

或者

```xml
<dubbo:registry protocol="zookeeper" address="191.168.10.101:2181" />
```

或者

```properties
dubbo.register.address=zookeeper://192.168.10.101:2181
```

或者

~~~properties
dubbo.register.protocol=zookeeper
dubbo.register.address=192.168.10.101:2181
~~~

**集群的配置**

~~~xml
<dubbo:registry address="zookeeper://191.168.10.101:2181?backup=191.168.10.102:2181,191.168.10.103:2181" />
~~~

或者

~~~xml
<dubbo:registry protocol="zookeeper" address="191.168.10.101:2181,191.168.10.102:2181,191.168.10.103:2181" />
~~~

或者

~~~~properties
dubbo.register.address=zookeeper://192.168.10.101:2181?backup=192.168.10.102:2181,192.168.10.103:2181
~~~~

或者

~~~~properties
dubbo.register.protocol=zookeeper
dubbo.register.address=192.168.10.101:2181,192.168.10.102:2181,192.168.10.103:2181
~~~~

### 父工程pom

```Xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
   <modelVersion>4.0.0</modelVersion>
   <packaging>pom</packaging>

   <modules>
      <module>dubbo-common</module>
      <module>dubbo-provider</module>
      <module>dubbo-consumer</module>
   </modules>
   <parent>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-parent</artifactId>
      <version>2.3.0.RELEASE</version>
      <!-- <version>2.2.6.RELEASE</version> -->
      <relativePath/> <!-- lookup parent from repository -->
   </parent>

   <groupId>xyz.guqing</groupId>
   <artifactId>project</artifactId>
   <version>0.0.1-SNAPSHOT</version>
   <name>project</name>
   <description>Demo project for Spring Boot</description>


   <!-- 统计版本管理 -->
   <properties>
      <java.version>8</java.version>
      <mybatis-plus.version>3.3.1.tmp</mybatis-plus.version>
      <!-- Spring Cloud Hoxton.SR5 依赖 -->
      <spring-cloud.version>Hoxton.SR5</spring-cloud.version>
      <!-- spring cloud alibaba 依赖 -->
      <spring-cloud-alibaba.version>2.1.0.RELEASE</spring-cloud-alibaba.version>
      <project.version>0.0.1-SNAPSHOT</project.version>
      <dubbo.version>3.0.7</dubbo.version>
   </properties>

   <!-- 项目依赖管理 父项目只是声明依赖，子项目需要写明需要的依赖(可以省略版本信息) -->
   <dependencyManagement>
      <dependencies>
         <!-- Dubbo Spring Boot Starter -->
         <dependency>
            <groupId>org.apache.dubbo</groupId>
            <artifactId>dubbo-spring-boot-starter</artifactId>
            <version>${dubbo.version}</version>
         </dependency>

         <!--fastjson -->
         <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.1.41</version>
         </dependency>

         <!-- 工具类 -->
         <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>5.0.5</version>
         </dependency>

         <!-- zookeeper start -->
         <dependency>
            <groupId>org.apache.dubbo</groupId>
            <artifactId>dubbo-dependencies-zookeeper</artifactId>
            <version>${dubbo.version}</version>
            <type>pom</type>
         </dependency>
         <!-- zookeeper end -->

      </dependencies>
   </dependencyManagement>
</project>
```

和无注册中心版本相比增加了

```Xml
<!-- zookeeper start -->
<dependency>
   <groupId>org.apache.dubbo</groupId>
   <artifactId>dubbo-dependencies-zookeeper</artifactId>
   <version>${dubbo.version}</version>
   <type>pom</type>
</dependency>
<!-- zookeeper end -->
```

### provider 子工程

增加了zookeeper依赖

```Xml
<!-- zookeeper start -->
<dependency>
    <groupId>org.apache.dubbo</groupId>
    <artifactId>dubbo-dependencies-zookeeper</artifactId>
    <type>pom</type>
</dependency>
<!-- zookeeper end -->
```

**配置文件applicaiton.yml**

```Java
server:
  port: 9091 # 端口

spring:
  application:
    name: dubbo-consumer # 应用名称

dubbo:
  registry:
    address: zookeeper://121.36.8.180:2181

# 版本信息，放到配置中
project:
  version: 1.0.0
```

修改点：增加了`dubbo.registry.address`的配置

### consumer子工程

依赖的jar包和provide相同

**配置文件applicaiton.yml**

```Java
server:
  port: 9091 # 端口


spring:
  application:
    name: dubbo-consumer # 应用名称

dubbo:
  registry:
    #address: N/A
    address: zookeeper://121.36.8.180:2181

# 版本信息，放到配置中
project:
  version: 1.0.0
```

修改点：`dubbo.registry.address`地址

**controller调用者**

```java
import org.apache.dubbo.config.annotation.DubboReference;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import xyz.guqing.dubbo.pojo.Product;
import xyz.guqing.dubbo.service.ProductService;

import java.util.List;

@RestController
public class MyController {

//    @DubboReference(version = "1.0.0", url = "dubbo://127.0.0.1:12345")
    @DubboReference(version = "${project.version}")
    private ProductService productService;

    @GetMapping("/t1")
    public List<Product> getList() {
        List<Product> products = productService.selectProductList();
        products.forEach(System.out::println);
        return products;
    }

}
```

修改点：`@DubboReference`注解不需要，不需要指定url地址

!> 到此，zookeeper 版本的配置修改完成，启动测试

[代码地址](https://gitee.com/L10052108/springboot_project/tree/dubbo-zookeeper/)