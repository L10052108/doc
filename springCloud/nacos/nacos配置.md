资料来源: <br/>
[Spring Cloud Alibaba—Nacos路由策略之保护阈值](https://www.toutiao.com/article/7064151088441655847/?log_from=e8ba6d1ccdba8_1646702002454)

[玩转Nacos参数配置！多图勿点](https://www.toutiao.com/article/7064151088441655847/?log_from=e8ba6d1ccdba8_1646702002454)



## nacos 参数
Nacos 中的参数有很多，如：命名空间、分组名、服务名、保护阈值、服务路由类型、临时实例等，那这些参数都是什么意思？又该如何设置？接下来我们一起来盘它。

Nacos 中通过命名空间 + 分组名 + 服务名可以定位到一个唯一实例，通常推荐使用由运行环境作为命名空间、应用名作为分组，服务功能作为服务名的组合来定义服务。

通常我们可以这样定义 Namespace，Group，DataId：

- `Namespace`：代表不同的**环境**，如：开发、测试， 生产等；
- `Group`：代表某个**项目**，如：XX物流项目，XX教育项目；
- `DataId`：每个项目下往往有若干个**应用**，每个配置集(DataId)是一个应用的**主配置文件**

![](large/e6c9d24ely1h1qezxn2azj20zk0b0jrz.jpg ':size=70%')



### 命名空间

在 Nacos 中通过命名空间（Namespace）+ 分组（Group）+服务名（Name）可以定位到一个唯一的服务实例。

![](large/e6c9d24ely1h1qdjp8yd6j20zn0hs3yw.jpg ':size=60%')

**命名空间（Namespace）：Nacos 服务中最顶层、也是包含范围最广的概念，用于强制隔离类似环境或租户等场景。Nacos 的服务也需要使用命名空间来进行隔离。**

点击左侧菜单 `命名空间`，看到默认有一个 `public(保留空间)`，点击右侧 `新建命名空间`进行创建。

![](large/e6c9d24ely1h1qdgvc6yxj22rk0ps77g.jpg ':size=75%')

命名空间默认为 public，在项目开发中，如果不指定命名空间，那么会使用默认值 public。**官方推荐使用运行环境来定义命名空间**，如生产版本可使用 public，开发版可定义为 private。

　如果 `spring.cloud.nacos.config.namespace` 中没有指定名称空间，则使用 Nacos 的 public(保留空间)。还可以按以下方式指定自定义名称空间：

~~~~java
spring.cloud.nacos.config.namespace=public
~~~~

### 分组名

**分组名（Group）：Nacos 中次于命名空间的⼀种隔离概念，区别于命名空间的强制隔离属性，分组属于⼀个弱隔离概念，主要用于逻辑区分⼀些服务使用场景或不同应用的同名服务，最常用的情况主要是同⼀个服务的测试分组和生产分组、或者将应用名作为分组以防止不同应用提供的服务重名。**

分组名在 Nacos 控制台的服务列表中可以看到，如下图所示：

![](large/e6c9d24ely1h1qdnze9bnj21t20oc419.jpg ':size=60%')

分组名默认为 DEFAULT_GROUP，在项目中可通过“

spring.cloud.nacos.discovery.group”来设置，如下图所示：

![](large/e6c9d24ely1h1qdoe7pczj218h05x3yu.jpg ':size=60%')

此项可省略，省略时的默认值为 DEFAULT_GROUP。

**分组名可以直接在项目中使用**，无需像命名空间那样，在使用前还要在控制台中新建，设定了分组名之后，刷新服务列表就可以看到新的分组名称了，如下图所示：

![](large/e6c9d24ely1h1qdpu7rw8j21sv0nqdij.jpg ':size=60%')

### 服务名

**服务名（Name）：该服务实际的名字，⼀般用于描述该服务提供了某种功能或能力。**

通常推荐使用由运行环境作为命名空间、应用名作为分组，服务功能作为服务名的组合来确保该服务的天然唯⼀性，当然使用者可以忽略命名空间和分组，仅使用服务名作为服务唯⼀标示，这就需要使用者在定义服务名时额外增加自己的规则来确保在使用中能够唯⼀定位到该服务而不会发现到错误的服务上。

服务名在项目中可以通过“spring.application.name”来指定，如下图所示

![](large/e6c9d24ely1h1qdpl8mk3j218d04qq34.jpg ':size=60%')

在 Nacos 的路由策略中有 3 个比较重要的内容：**权重**、**保护阈值**和**就近访问**。因为这 3 个内容都是彼此独立的，所以今天我们就单独拎出“保护阈值”来详细聊聊。

### 临时实例 VS 持久化实例

临时实例和持久化实例的区别主要有以下两点：

- 临时实例在非健康状态下会被自动剔除，而持久化实例不会被自动剔除。
- 临时实例的健康状况是 Nacos 客户端以固定频率（5s一次）上报给 Nacos 服务器端的，而持久化实例是 Nacos 服务器端主动探测的

## 保护阈值

保护阈值是牺牲⼀部分流量，保证集群中剩余健康实例能正常工作的一种手段。服务路由类型和权重都是用来定义 Nacos 路由规则的，而临时实例和持久化实例是 Nacos 中的两种实例类型。

### 介绍

**保护阈值（ProtectThreshold）：为了防止因过多实例故障，导致所有流量全部流入剩余健康实例，继而造成流量压力将剩余健康实例被压垮形成雪崩效应。应将健康保护阈值定义为⼀个 0 到 1 之间的浮点数。当域名健康实例数占总服务实例数的比例小于该值时，无论实例是否健康，都会将这个（健康或不健康的）实例返回给客户端。这样做虽然损失了⼀部分流量，但是保证了集群中剩余健康实例能正常工作。**

也就是说，保护阈值是设置集群中健康实例占比允许的最小值，它需要设置一个 0-1 的浮点值，默认值为 0，当集群中的健康实例占比小于设置的保护阈值时，就会触发阈值保护功能。保护阈值可在服务详情中查询和设置，如下图所示：<br/>
![](large/e6c9d24ely1h0jnzoxutqj214v0u0wgh.jpg ':size=50%')

### 如何理解保护阈值？

**要理解保护阈值先要明确一个前提条件：对于 Nacos 的注册中心功能来说，Nacos 有一个天然的职责，是将服务消费者（Consumer）的请求转发给某个健康的服务提供者（Provider）。**

但在执行的流程中，可能会出现一种极端的情况，比如某个服务有 100 个实例，其中 99 个实例都宕机了，只剩下一个健康的实例，这个时候如果把所有的请求都转发到这一个健康实例上就会造成雪崩效应，最终导致业务系统崩溃。

为了防止这种极端情况，于是就有了“保护阈值”，保护阈值一旦被触发，那么 Nacos 将会把请求转发给所有服务实例，也就是健康实例+非健康实例，这样可能会损失了⼀部分流量，但能保证集群中剩余的健康实例能正常工作。

保护阈值触发条件：（实际健康实例/总服务实例）≤设置的保护阈值

### 设置保护阈值

我们可以通过“编辑服务”来设置保护阈值，如下图所示：<br/>
![](large/e6c9d24ely1h0jnzye1yxj21750u0wgh.jpg ':size=50%')<br/>

### 触发保护阈值

接下来我们创建一个服务测试一下保护阈值的功能，在创建的服务中添加两个实例，如下图所示：
![](large/e6c9d24ely1h0jo0cmtwhj21sz0o7dih.jpg ':size=70%')<br/>
![](large/e6c9d24ely1h0jo0ikbxnj214v0u0ac2.jpg ':size=70%')<br/>

默认情况下服务实例都是健康的，接下来我们将保护阈值设置为 0.8，也就是健康实例的最低要求是 80%，如果健康实例占比小于此值就会触发保护阈值，如下图所示：
![](large/e6c9d24ely1h0jo0r4xw3j214g0u0764.jpg ':size=70%')<br/>

当所有节点都健康时，观察服务列表页面，可以看出并未触发保护阈值的功能，如下图所示：
![](large/e6c9d24ely1h0jo0xpki3j21sz0oytbo.jpg ':size=70%')<br/>
此时我们手动停止一个服务实例，如下图所示：<br/>
![](large/e6c9d24ely1h0jo11zo8vj214m0u0q4t.jpg ':size=70%')<br/>
这是健康实例的占比就从 100%，下降到了 50%，小于了设置的保护阈值 0.8（80%），接下来返回服务列表页面，可以看到保护阈值功能被触发了：
![](large/e6c9d24ely1h0jo1dijsdj21t10otad0.jpg ':size=70%')<br/>
此时，我们再去访问服务就会看到，部分请求会转发到非健康实例，也就是访问会出错，如下图所示：
![](large/e6c9d24ely1h0jo1m94luj21ei0d4gos.jpg ':size=70%')<br/>
### 未触发保护阈值

接下来我们降低保护阈值，将保护阈值设置为 0.3，也就是健康实例占比最低要求是 30%，否则会触发阈值保护，如下图所示：
![](large/e6c9d24ely1h0jo1r2phzj214n0u040e.jpg ':size=70%')<br/>
而此时因为我们健康实例占比是 50%，大于设置的阈值保护 0.3，所以就不会触发阈值保护，这点可以在服务列表中观察到：
![](large/e6c9d24ely1h0jo1v12elj21sz0npjuh.jpg ':size=70%')<br/>
当未触发保护阈值时，Nacos 会把所有请求都转发到健康的实例上，所以每次都能正常的访问服务，执行效果如下图所示：
![](large/e6c9d24ely1h0jo1zebvpj21ek064mye.jpg ':size=70%')
### 总结

保护阈值是为了防止因过多实例故障，导致所有流量全部流入剩余健康实例，继而造成流量压力将剩余健康实例被压垮形成雪崩效应。它的默认值是 0，取值范围应该是 0-1 的浮点数。此值是定义集群中允许健康实例占比的最小值，如果实际健康服务占比小于或等于此值，就会触发保护阈值，那么 Nacos 就会将全部实例：健康实例 + 非健康实例全部返回给调用者，而当保护阈值未触发时，Nacos 只会把健康实例返回给调用者。