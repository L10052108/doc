资料来源：<br/>
[JVM系列-2.字节码文件详解](https://juejin.cn/post/7326080299942395944)<br/>

# 字节码文件详解

## JVM的组成

![1.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f7bcf1183f94716b7656873cff0f1de~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1053&h=522&s=158355&e=png&b=fefdfd)

![2.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df6b98c2c5bd4b4ca66697cb23fd38a4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1063&h=520&s=184819&e=png&b=fdfcfc)

## 字节码文件的组成

学习字节码文件有什么用呢？

![3.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/85289d7d5ec045c3a5ab7f73cc5f5cd7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=643&h=333&s=44029&e=png&b=faf3f3)

能够从字节指令的角度去回答疑难杂症的面试题。

其他的应用场景呢？

![4.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/819d7001ca234e3b90ecf2cce9a0e9d3~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=594&h=376&s=52644&e=png&b=fefdfd)

![5.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e6232f9628934ee4b22b9729cff9cd5e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=691&h=423&s=63113&e=png&b=fefdfd)



### 以正确的姿势打开文件

字节码文件中保存了源代码编译之后的内容，以二进制的方式存储，无法直接用记事本打开阅读。

通过NotePad++使用十六进制插件查看class文件：

![6.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ffb8d192647c4b428894bea9e4637dd3~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=796&h=352&s=102478&e=png&b=fbfbfb)

推荐使用**jclasslib**工具查看字节码文件。

在github下载之后打开

![7.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/130959fe3c234e7d81d4f98f45923d5b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1141&h=570&s=112290&e=png&b=dfdfdf)

![8.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e60a14141234060aade07914921e52f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=682&h=324&s=56219&e=png&b=f6f5f5)

接下来简单分析下字节码中的信息。

![9.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ac0b912a9a7429aab5793614cc21924~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1054&h=478&s=86806&e=png&b=fbfbfb)

![10.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/50024ea272d949fbb74df7454bb01da4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1060&h=504&s=84475&e=png&b=fdfcfc)

![11.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c76769307028440e8aa04d0fb87471b2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=997&h=487&s=87031&e=png&b=fcfbfb)

![12.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63b1e4cf279a4a68ae5242e97244989a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=990&h=514&s=94605&e=png&b=fcfcfc)

详细的看一下里面的字节码指令

![13.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f475eb71fe074cc9bd08c435e57b8dc8~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=829&h=430&s=86449&e=png&b=faf9f9)

![14.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/629e091381804952b1c936f42fe54426~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1003&h=493&s=71717&e=png&b=fcfcfc)

### 字节码文件的组成

![15.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/114b457114bf404f8be3b6600ac12e7f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=939&h=510&s=96803&e=png&b=fefdfd)

**字节码文件的组成部分-Magic魔数**

![16.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5df890d960254169b631566840e23c7c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=670&h=454&s=84047&e=png&b=fcfcfc)

文件是无法通过文件扩展名来确定文件类型的，文件扩展名可以随意修改，不影响文件的内容。

软件使用文件的头几个字节（文件头）去校验**文件的类型**，如果软件不支持该种类型就会出错。

**Java字节码文件中，将文件头称为magic魔数。**

![17.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/432f9f85a49f41cea28464e4aaa93fd6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=660&h=315&s=52758&e=png&b=f0f0f0)

**字节码文件的组成部分-主副版本号**

![18.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9fc5f887f9bb408384f8d723764dd42e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1006&h=445&s=126401&e=png&b=fcfbfb)

### 主版本号不兼容导致的错误

**需求：**

解决以下由于主版本号不兼容导致的错误

![19.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7f4d8dec15946eea95bc2020e42a76d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=579&h=85&s=34291&e=png&b=fcf8f8)

两种方案：

1.升级JDK版本

2.将第三方依赖的版本号降低或者更换依赖，以满足JDK版本的要求 （容易引发其他的兼容性问题，并且需要大量的测试）√ 建议采用

![20.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/45b565f17cdd4ab594af5bc083f0b0d9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1053&h=490&s=116992&e=png&b=f4f3f3)

### 字节码文件的组成部分-常量池

字节码文件中常量池的作用：避免相同的内容重复定义，节省空间。

![21.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/833aa929105e4656a76f004e3df91503~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=976&h=402&s=63245&e=png&b=fef8f5)

常量池中的数据都有一个编号，编号从1开始。在字段或者字节码指令中通过编号可以快速的找到对应的数据。

![22.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a082e5a51b7d4483a2a8fe6576aab1ec~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1126&h=597&s=196704&e=png&b=f2f2f2)

字节码指令中通过编号引用到常量池的过程称之为符号引用。

![23.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7e47983cd1f64d539f0855265cc499d7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=904&h=346&s=74494&e=png&b=fffcfb)

### 字节码文件的组成部分-方法

一个非常有意思的面试题：

![24.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1136be7fd70942c58dcb47fbfb305605~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=808&h=267&s=43930&e=png&b=fcf8f8)

字节码中的方法区域是存放**字节码指令**的核心位置，字节码指令的内容存放在方法的Code属性中。

![25.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f5f9815755e47b683a9ad92434acfa3~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=996&h=364&s=51041&e=png&b=fdfdfd)

操作数栈是临时存放数据的地方，局部变量表是存放方法中的局部变量的位置。

![26.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/be9c9a9d82944cb38ac01655eacb204b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=976&h=411&s=119220&e=png&b=fffaf9)

i=i++的执行流程：

![27.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44fc2e60ed7e462c9050ab144d390b04~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1021&h=465&s=112362&e=png&b=fffcfb)

i=++i的执行流程：

![28.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e950613f45fe4acb894c39f7cdffb445~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1023&h=454&s=106029&e=png&b=fffcfb)

通过分析方法中的字节码指令，我们成功的解决了这个问题

![29.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11ef197af15f4d7faef740761962e9b2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=772&h=297&s=55123&e=png&b=fcf7f7)

## 字节码文件常用工具

### 玩转字节码常用工具: javap -v命令

javap是JDK自带的反编译工具，可以通过控制台查看字节码文件的内容。适合在服务器上查看字节码文件内容。

直接输入javap查看所有参数。

输入javap -v 字节码文件名称 查看具体的字节码信息。（**如果jar包需要先使用 jar –xvf 命令解压**）

![30.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f6a9db76d7441df986ef43ac6ad57c0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=538&h=297&s=118610&e=png&b=282d34)

例如：**javap -v /opt/jvm/BOOT-INF/classes/com/itheima/springbootclassfile/pojo/vo/UserVo.class > /opt/jvm**

### 玩转字节码常用工具: jclasslib插件

jclasslib也有Idea插件版本，建议开发时使用Idea插件版本，可以在代码编译之后实时看到字节码文件内容。

![31.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c26781709c8f4a4aa4d37de99ac71a32~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=910&h=303&s=70881&e=png&b=fcfcfc)

需要将该文件从服务器上下载下来才能使用jclasslib

### 玩转字节码常用工具: 阿里arthas

Arthas 是一款线上监控诊断产品，通过全局视角实时查看应用 load、内存、gc、线程的状态信息，并能在不修改应用代码的情况下，对业务问题进行诊断，大大提升线上问题排查效率。

![32.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/130772f0d06b445abeacdd1c5dc63e58~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=469&h=241&s=18830&e=png&b=ffffff)

下载好的atheas是一个jar，通过 java -jar arthas.jar 启动

![33.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dbafed6131d14127be8443c59d701aa9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=733&h=382&s=118707&e=png&b=272d37)

输入5就可以进入到对应的程序中

![34.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/434f3c0716b5498aa05ce9fd20c8d685~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=988&h=508&s=235964&e=png&b=262c36)

其中arthas包含了很多功能

![35.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/84d8a79666034532959545224ca16e32~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=940&h=427&s=71163&e=png&b=fefefe)

dump 类的全限定名：dump已加载类的字节码文件到特定目录。

jad 类的全限定名： 反编译已加载类的源码。

### 使用阿里arthas定位线上出现的字节码问题

背景： 小李的团队昨天对系统进行了升级修复了某个bug，但是升级完之后发现bug还是存在，小李怀疑是因为没有把最新的字节码文件部署到服务器上，请使用阿里的arthas去确认升级完的字节码文件是不是最新的。

思路：

1. 在出问题的服务器上部署一个 arthas，并启动。
2. 连接 arthas的控制台，使用 jad命令加上想要查看的类名，反编译出源码。
3. 确认源码是否是最新的。



作者：爱吃芝士的土豆倪
链接：https://juejin.cn/post/7326080299942395944
来源：稀土掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。