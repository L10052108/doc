### 那你说说Mybatis里面的缓存机制吧?

资料来源：[那你说说Mybatis里面的缓存机制吧?](https://www.toutiao.com/video/7087139756894585357/?from_scene=all)

昨天一个工作了 4 年的粉丝去面试，被问到 Mybatis 里面的缓存机制时，哆嗦了半天没回答上来。

然后回来就在群里面抱怨面试太卷了，实际上，Mybatis 多级缓存在开发中是会用到的一个功能，如果这个部分没弄清楚。

可能会出现一些莫名其妙的问题，最后又得通过百度帮你解决，个人能力还是没有提升。我之前给大家分享的 20W 字的面试文档里面也有这个问题的标准回答，短期面试突击的话还是可以去看一下，具体可以在评论区的置顶中领取。

#### 回答正题，
（如图）Mybatis 里面设计的二级缓存是用来提升数据的检索效率，避免每次数据的访问都需要去查询数据库。

一级缓存，是 SqlSession 级别的缓存，也叫本地缓存，因为每个用户在执行查询的时候都需要使用 SqlSession 来执行，为了避免每次都去查数据库，Mybatis 把查询出来的数据保存到 SqlSession 的本地缓存中，后续的 SQL 如果命中缓存，就可以直接从本地缓存读取了。
如果想要实现跨 SqlSession 级别的缓存？那么一级缓存就无法实现了，因此在Mybatis 里面引入了二级缓存，就是当多个用户在查询数据的时候，只有有任何一个 SqlSession 拿到了数据就会放入到二级缓存里面，其他的 SqlSession 就可以从二级缓存加载数据。  

![image-20231228135911377](img/image-20231228135911377.png)

(如图）一级缓存的具体实现原理是：
在 SqlSession 里面持有一个 Executor，每个 Executor 中有一个 LocalCache 对象。当用户发起查询的时候，Mybatis 会根据执行语句在 Local Cache 里面查询，如果没命中，再去查询数据库并写入到 LocalCache，否则直接返回。

所以，以及缓存的生命周期是 SqlSessiion，而且在多个 Sqlsession 或者分布式环境下，可能会导致数据库写操作出现脏数据。  

![image-20231228135939387](img/image-20231228135939387.png)



（如图）二级缓存的具体实现原理是：
使用 CachingExecutor 装饰了 Executor，所以在进入一级缓存的查询流程之前，会先通过 CachingExecutor 进行二级缓存的查询 。

开启二级缓存以后，会被多个 SqlSession 共享，所以它是一个全局缓存。因此它的查询流程是先查二级缓存，再查一级缓存，最后再查数据库。另外，MyBatis 的二级缓存相对于一级缓存来说，实现了 SqlSession 之间缓存数据的共享，同时缓存粒度也能够到 namespace 级别，并且还可以通过 Cache 接口实现类不同的组合，对 Cache 的可控性也更强。  

![image-20231228140017572](img/image-20231228140017572.png)



二级缓存的设计思想非常常见，比如 Nacos、Eureka 都用到了，学习这块的思想有助于提升解决问题的能力。
好了，今天的分享就到这里，在面试的时候大家还有遇到哪些比较难的问题，欢迎在评论区留言  

<hr/>


### Mybatis是如何进行分页的

资料来源：[Mybatis是如何进行分页的](https://www.toutiao.com/video/7137869607662158350/?from_scene=all)

“Mybatis 是如何进行分页的”？
这是一个工作了 3 年的同学，在面试的时候遇到的问题。
Hi，大家好，我是 Mic，一个工作了 14 年的 Java 程序员。
下面我们来分析一下面试官对于这个问题的考察意图。
#### 考察目标
Mybatis 是 Java 应用开发的基础框架，而分页又是我们实时都在使用的功能。

因此，在我看来，一方面考察的是求职者对 Mybatis 框架的使用能力

另一方面，以此为切入点去深度挖掘 Mybatis 里面更多的问题，从而了解求职者对它的理解深度。

这道题考察难度不大，主要考察 1-3 年 Java 开发经验的同学。
问题解析
数据进行分页是最基础的功能，一般可以把分页分成两类：

- 逻辑分页，先查询出所有的数据缓存到内存，再根据业务相关需求，从内存数据中
  筛选出合适的数据进行分页。 

- 物理分页 ，直接利用数据库支持的分页语法来实现，比如 Mysql 里面提供了分页
  关键词 Limit
  Mybatis 提供了四种分页方式：

- 在 Mybatis Mapper 配置文件里面直接写分页 SQL，这种方式比较灵活，实现也
  简单。

- RowBounds 实现逻辑分页，也就是一次性加载所有符合查询条件的目标数据，根
  据分页参数值在内存中实现分页。  

当然，在数据量比较大的情况下，JDBC 驱动本身会做一些优化，也就是不会把所有结
果存储在 ResultSet 里面，
而是只加载一部分数据，再根据需求去数据库里面加载。
这种方式不适合数据量较大的场景，而且有可能会频繁访问数据库造成比较大的压力。

- Interceptor 拦截器实现，通过拦截需要分页的 select 语句，然后在这个 sql 语句
  里面动态拼接分页关键字，从而实现分页查询。
  （如图）Interceptor 是 Mybatis 提供的一种针对不同生命周期的拦截器，比如：

- 拦截执行器方法

- 拦截参数的处理

- 拦截结果集的处理

- 拦截 SQL 语法构建的处理

我们可以拦截不同阶段的处理，来实现 Mybatis 相关功能的扩展  

![image-20231228135706351](img/image-20231228135706351.png)



这种方式的好处，就是可以提供统一的处理机制，不需要我们再单独去维护分页相关的
功能。

- 插件（PageHelper）及（MyBaits-Plus、tkmybatis）框架实现
  这些插件本质上也是使用 Mybatis 的拦截器来实现的。
  只是他们帮我们实现了扩展和封装，节省了分页扩展封装的工作量，在实际开发中，只
  需要拿来即用即可。  

总结一下，对于任何 ORM 框架，分页的实现逻辑无外乎两种，不管怎么包装，最终给
到开发者的，只是使用上
的差异而已。
那么，我们来看看高手该如何回答。
#### 高手回答
好的。
我认为有三种方式来实现分页：

- 第一种，直接在 Select 语句上增加数据库提供的分页关键字，然后在应用程序里
  面传递当前页，以及每页展示条数即可。 

- 第二种，使用 Mybatis 提供的 RowBounds 对象，实现内存级别分页。

- 第三种，基于 Mybatis 里面的 Interceptor 拦截器，在 select 语句执行之前动态
  拼接分页关键字。

以上就是我的理解。
总结
大家知道怎么回答了吗？
如果你喜欢我的作品，记得点赞收藏加关注哦
我是 Mic，咱们下期再见  