资料来源：<br/>
[如何用 Nginx 代理 MySQL 连接，并限制可访问IP？](https://mp.weixin.qq.com/s/6lvKIQb4yk7uTmufr9pJ8w)

## Nginx代理连接

我们的生产环境基本上都部署在云服务器上，例如应用服务器、MySQL服务器等。如果MySQL服务器直接暴露在公网，就会存在很大的风险，为了保证数据安全，MySQL服务器的端口是不对外开放的。

要实现对连接的代理转发，我们需要一台服务器并安装Nginx，且与MySQL服务器处于一个内网之中，内网之间可以访问。

其次，我们需要用到`ngx_stream_core_module`模块，该模块不是默认构建的，我们需要在configure时添加`--with-stream`来进行构建。

添加过程可以参照【Nginx基本命令&不停机版本升级】一文进行，我们这里不再赘述。

既然要用到`ngx_stream_core_module`模块，首当其冲，是看看其提供的指令，我们才知道怎么来进行配置。

### stream

该指令定义了stream服务器。与http块平级，定义在main块中。

- 作用域：main
- 语法：stream {...}

示例：

```c
 stream {
     server {
         ......
     }
 }
```

### server

该指令定义一个虚拟主机，与http块中的server类似。我们可以在stream块中定义多个server块。

- 作用域：stream
- 语法：server {...}

```c
stream {
     server {
         ......
     }
     server {
         ......
     }
 }
```

### listen

该指令定义虚拟主机server要监听的socket的地址和端口。

- 作用域：server
- 语法：listen address:port;

示例：

```
listen 127.0.0.1:3306;
 listen *:3306;
 # 效果与listen *:3306一样
 listen 3306;
 listen localhost:3306;
```

### 配置示例

MySQL服务器，端口3306（单机环境）

```
stream  {
     server {
         listen 3306;
         proxy_pass 192.168.110.101:3306;
     }
 }
```
MySQL服务器，端口3306（集群环境）

```
stream  {
     upstream mysql_socket {
         server 192.168.110.101:3306;
     }
     server {
             listen 3306;
             proxy_pass mysql_socket;
     }
 }
```



